/**
 * Copyright (c) 2018-present, A2 Re≈°itve d.o.o.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is
 * distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See
 * the License for the specific language governing permissions and limitations under the License.
 */

package solutions.a2.cdc.oracle.internals;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static solutions.a2.cdc.oracle.OraCdcV$LogmnrContents.DELETE;
import static solutions.a2.oracle.utils.BinaryUtils.hexToRaw;

import java.io.IOException;

import org.apache.log4j.BasicConfigurator;
import org.junit.jupiter.api.Test;

import solutions.a2.cdc.oracle.OraCdcRedoMinerStatement;
import solutions.a2.cdc.oracle.OraCdcTransaction;
import solutions.a2.cdc.oracle.OraCdcTransactionArrayList;

/**
 *  
 * @author <a href="mailto:averemee@a2.solutions">Aleksei Veremeev</a>
 * 
 */
public class Ops_DRP_LMN_BindingTest {

	@Test
	public void test() {

		BasicConfigurator.configure();

		OraCdcRedoLog orl = OraCdcRedoLog.getLinux19c();
		
		byte[] baDelete1 = hexToRaw("000200000116050D436AD2DB1E0000000000000000000F00050128000400FFFF51020001436AD2DB050D00001900FFFF00000000000000003E00140018001C00340004000000050003000200030002000700070007000200020001000100010001000100010001000100010002000100010001001400000028015409220000000C0012007C15050029592C00CDC90200CDC902000C000000000000000B01122A00007C150405000007001900165C1000EA1F0001460F0C00058D00807868D2DB733E1203E2190003A21F2201010000002C00190000000000000000000000000000000000000000005600010000020000D854660DC32D1D09C40B01600F000000C20F6400C1052000C2020600C1020C00787D0B0B0E3A0C00787D0B0B0E3A0C00787D0B0B01010100C1032600C203FFFF80060001805CD2DB800D00008000FFFF800000008000000080001400800000008000EC0BC102000080000A0001FB0C0080D8260004180000030001000000000000000000000200000B0301000C000200733E1203366AD2DB050D00000102CDC9000000000000000006004C0014000000110555530C0012007C1505005102000129592C00460200003025555346020000D02555534602000002020D53436AD2DB0080050D010600807868D2DB02060080366AD2DB050D050D00000000733E1203E2190003A21F03010100000001000000");
		OraCdcRedoRecord rrDelete1 = new OraCdcRedoRecord(orl, 0x00000d05dbd26a43l, "0x003573.0001fde8.01bc", baDelete1);
		assertTrue(rrDelete1.has5_1());
		assertFalse(rrDelete1.has10_x());
		assertTrue(rrDelete1.has11_x());

		byte[] ba_11_16Lmn1 = hexToRaw("1C0100000100050D436AD2DB1F0000000000000000000000050128000400FFFF51020001436AD2DB050D00001A00FFFF00000000000000001200140018000C0010001C0002000200010097AE6C002A08220000000C0012007C15050029592D46CDC90200CDC902000C000000000000000B01122C00007C15020597AE5102000129592C00733E1203E2190003A21F3001010000000404010003000000000000000004000000020000733E1203010000001900020001000400800006000B1001000C000200733E1203436AD2DB050D00000100CDC9000000000000000008000C0010001C00020500005102000129592D00733E1203E2190003A21F100101000000041C000003000000000000000004000000020000733E120301000000"); 
		OraCdcRedoRecord rr_11_16Lmn1 = new OraCdcRedoRecord(orl, 0x00000d05dbd26a43l, "0x003573.0001fde9.01cc", ba_11_16Lmn1);
		assertTrue(rr_11_16Lmn1.has5_1());
		assertFalse(rr_11_16Lmn1.has10_x());
		assertTrue(rr_11_16Lmn1.has11_x());
		
		assertEquals(rrDelete1.halfDoneKey(), rr_11_16Lmn1.halfDoneKey());


		byte[] baDelete2 = hexToRaw("100200000100050D436AD2DB290000000000000000000000050128000400FFFF51020001436AD2DB050D00001E00FFFF00000000000000005E00140018000C003600030002000500050007000700070007000200020001000100010003000300040001000100030003000200020001000300020002000100030002000200020003000300010000000000000000000100010001001400000078018A06220000000C0012007C15050029593145CFCE0200CFCE02000C000000000000000B01123000007C15020500005002000129592C008576000382760003A21F2201020000002C02290000000000000000000000000000000000000000009000010000000000003CB42346021700C20F6400C1050000C40B01600F002FFBC406010103001400787D0B0B01010101787D0B0B01010180787D0B0B0E39395E787D0B0B0E3A0C00C1020000C103000080C5033C802B390680C22C513D6366363E6366003F5A4D668060C200805CD2DBC2020600C20218E1C1020000C102000080001400C2040F00C1022500C1020A004CFB0C003E596601C1122A00C0028F00C10300004E47443C4E47440680C22C5180320000010200008000050D04180000050001000000000000000000000200000B0301000C000200857600033B6AD2DB050D00000200CFCE000000000000000006000C0014001C0002052D0051020001295931008576000382760003A21F030102000000010000A1");
		OraCdcRedoRecord rrDelete2 = new OraCdcRedoRecord(orl, 0x00000d05dbd26a43l, "0x003573.0001fded.003c", baDelete2);
		assertTrue(rrDelete2.has5_1());
		assertFalse(rrDelete2.has10_x());
		assertTrue(rrDelete2.has11_x());

		byte[] ba_11_16Lmn2 = hexToRaw("1C010000015C050D436AD2DB2A0000FF0000000000000000050128000400FFFF51020001436AD2DB050D00001F00FFFF00000000000000001200140018000C0010001C0002000200010039AA6C001005220000000C0012007C15050029593246CFCE0200CFCE02000C000000000000000B01123100007C15020539AA51020001295931008576000382760003A21F300102000000040401000500000000000000000400000002000085760003010000002900000001000000800000000B1001000C00020085760003436AD2DB050D00000100CFCE000000000000000008000C0010001C000205000051020001295932008576000382760003A21F100102000000041C0000050000000000000000040000000200008576000301000000"); 
		OraCdcRedoRecord rr_11_16Lmn2 = new OraCdcRedoRecord(orl, 0x00000d05dbd26a43l, "0x003573.0001fdee.005c", ba_11_16Lmn2);
		assertTrue(rr_11_16Lmn2.has5_1());
		assertFalse(rr_11_16Lmn2.has10_x());
		assertTrue(rr_11_16Lmn2.has11_x());

		assertEquals(rrDelete2.halfDoneKey(), rr_11_16Lmn2.halfDoneKey());


		OraCdcTransaction transaction = new OraCdcTransactionArrayList("0x000c.012.0005157c", 0x00000d05dbd26a43l, 0x10, orl.cdb());
		OraCdcRedoMinerStatement stmt = new OraCdcRedoMinerStatement();
		try {
			transaction.processRowChange(rrDelete1, false, System.currentTimeMillis());
			transaction.processRowChange(rr_11_16Lmn1, false, System.currentTimeMillis());
			transaction.processRowChange(rrDelete2, false, System.currentTimeMillis());
			transaction.processRowChange(rr_11_16Lmn2, false, System.currentTimeMillis());
			transaction.setCommitScn(0xd05dbd26a4al);

			assertTrue(transaction.completed());

			assertTrue(transaction.getStatement(stmt));
			assertEquals(stmt.getOperation(), DELETE);
			assertEquals(stmt.getRba(), rrDelete1.rba());
			assertEquals(stmt.getRowId().toString(), "AAAsnNAAMAAEj5zAAB");
			System.out.println(stmt);

			assertTrue(transaction.getStatement(stmt));
			assertEquals(stmt.getOperation(), DELETE);
			assertEquals(stmt.getRba(), rrDelete2.rba());
			assertEquals(stmt.getRowId().toString(), "AAAs7PAAMAAAHaFAAB");
			System.out.println(stmt);

		} catch(IOException ioe) {}

	}
}
