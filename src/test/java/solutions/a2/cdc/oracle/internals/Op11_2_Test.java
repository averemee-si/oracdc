/**
 * Copyright (c) 2018-present, A2 Re≈°itve d.o.o.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is
 * distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See
 * the License for the specific language governing permissions and limitations under the License.
 */

package solutions.a2.cdc.oracle.internals;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static solutions.a2.cdc.oracle.OraCdcV$LogmnrContents.INSERT;
import static solutions.a2.cdc.oracle.internals.OraCdcChange._11_2_IRP;
import static solutions.a2.oracle.utils.BinaryUtils.hexToRaw;

import java.io.IOException;

import org.junit.jupiter.api.Test;

import solutions.a2.cdc.oracle.OraCdcRedoMinerStatement;
import solutions.a2.cdc.oracle.OraCdcTransaction;
import solutions.a2.cdc.oracle.OraCdcTransactionArrayList;

/**
 *  
 * @author <a href="mailto:averemee@a2.solutions">Aleksei Veremeev</a>
 * 
 */
public class Op11_2_Test extends TestWithOutput {

	@Test
	public void singleRedoRecord() {

		OraCdcRedoLog orl = OraCdcRedoLog.getLinux19c();
		
		byte[] baInsert1 = hexToRaw("980200000500000099E2DC03010000003A00ADD1000000000000010003000000030000000A00000098E2DC030000000097E2DC03000000009CE2DC0300000000FF6D9C4805021D000B00FFFFE000400247E0DC03000000000100FFFF0300000000000000060020000400000012000000EE0C0000340A400219040A005200880000FF000000000000000000003A00ADD105011E000B00FFFF340A400246E0DC03000000000300FFFF03000000000000000C0014004C000800140014008800F8191200000007001200EE0C000019040A00412701004127010005000000000000000B011200080C010000000000340A4002190407008B13DB03000000009613DB030000000001000000FFFFFFFFFFFFFFFF300A40020000000000000000030D000000000000DB000003DA000003FA1223010100000000000000021C0000010000000100000000000000000200000B0201000C000100DB00000360353C0100000000020041270300000000000000160018003100030004000800030007000300020002000000010D00000000000007001200EE0C0000340A400219040A00DB000003DA000003FA120201010000002C01080000000000000000000000000000000000000000002B0000000000000000000000C24C16005741524453414C45534D414EC24D630077B5021601010100C20D3300C2060000C11F000005130000000000000000000000000000000000000006000003000000000000002000080003000300000006000C0005000300200000000600040004000000000000006A62E800000053595300535953006F7261636C6500003932326264343936653439317074732F300000003732330073716C706C7573403932326264343936653439312028544E532056312D563329000001000000000000000013FFFFFFFF");
		OraCdcRedoRecord rrInsert1 = new OraCdcRedoRecord(orl, 0x0000000003dce299l, "0x000363.00001224.0010", baInsert1);
		assertTrue(rrInsert1.has5_1());
		assertTrue(rrInsert1.change5_1().supplementalLogData());
		assertTrue(rrInsert1.change5_1().supplementalFb() != 0);
		assertTrue(rrInsert1.change5_1().fb() == 0);
		assertFalse(rrInsert1.has10_x());
		assertTrue(rrInsert1.has11_x());
		assertTrue(rrInsert1.change11_x().fb() != 0);
		assertEquals(rrInsert1.change11_x().operation, _11_2_IRP);

		OraCdcTransaction transaction = new OraCdcTransactionArrayList("0x0007.012.00000cee", 0x0000000003dce299l, 0x10, orl.cdb());
		OraCdcRedoMinerStatement stmt = new OraCdcRedoMinerStatement();
		try {
			transaction.processRowChange(rrInsert1, false, System.currentTimeMillis());
			transaction.setCommitScn(0x0000000003da258al);

			assertTrue(transaction.completed());

			assertTrue(transaction.getStatement(stmt));
			assertEquals(stmt.getOperation(), INSERT);
			assertEquals(stmt.getRba(), rrInsert1.rba());
			assertEquals(stmt.getRowId().toString(), "AAASdBAAMAAAADbAAA");
			System.out.println(stmt);

		} catch(IOException ioe) {}
	}

	@Test
	public void testRaInterfaceLinesAll_Reverse() {

		OraCdcRedoLog orl = OraCdcRedoLog.getLinux19c();
		
		byte[] baInsert1 = hexToRaw("0C04000001008D05AD2F4AF30300000007D7CD51000000000501FE005600FFFFD0C980154B2C4AF38D0500000600FFFF03000000000000000C0014001800200014001C007400BE0422000000770020006C991B00370643001F9B02001F9B020007000000000000000B01204200006C99040D491766C423003B000B000B64380019778D152D8316008D8500808A024FF1998D00043203C0037D09230102000000000000B602080000090000005C0000000000010000000000998D00040000008B0B0201001A000200998D0004AD2F4AF38D05000001001F9B03000000000000000402180050000A000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000030001001E001E001E0000000500000000000000000000000100000000000000000001000700010007000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020007000500010D000000000000770020006C991B00D0C9801537064300998D00043203C0037D090201020000000402FF00FF7F000000D080220000000000000000000000009A010000007EFFFFFFFFFFFFFFFFFFFFFFFDFF0FFA1EEEFFFFFFFFFFFFBFFFFFFFFFFFFF0F002100343930303238363130320000C4082E150300000043410000323631003000000020202020202020202020202020202020202020202020202020202020203100002020202020202020202020202020202020202020202020202020202020300000202020202020202020202020202020202020202020202020202020202030000035333938330000005300000080000000787D0C100B393B0080000000787D0C100B393B00C1540000C2033E00C1020000787D0C0811153900C41B21275B000000");
		OraCdcRedoRecord rrInsert1 = new OraCdcRedoRecord(orl, 0x0000058df34a2fadl, "0x00434e.00f8af9d.011c", baInsert1);
		assertTrue(rrInsert1.has5_1());
		assertTrue(rrInsert1.change5_1().supplementalLogData());
		assertTrue(rrInsert1.change5_1().supplementalFb() != 0);
		assertTrue(rrInsert1.change5_1().fb() == 0);
		assertFalse(rrInsert1.has10_x());
		assertTrue(rrInsert1.has11_x());
		assertTrue(rrInsert1.change11_x().fb() != 0);
		assertEquals(rrInsert1.change11_x().operation, _11_2_IRP);

		byte[] baInsert2 = hexToRaw("0803000001008D05AD2F4AF30400000007D7CD51000000000501FE005600FFFFD0C98015AD2F4AF38D0500000100FFFF03000000000000000C0014001800100014001C006400480422000000770020006C991B00370644001F9B02001F9B020007000000000000000B01204300006C99020D491766C42300D0C9801537064300998D00043203C0037D09230102000000010000B60204000009000000010000000000010000000000998D00040000008B0B0201001A000200998D0004AD2F4AF38D05000002001F9B0300000000000000BC0010003C0000000B00070012000800010001000800010006000F00030004003D0003000500000003000000040000000000040000000400000000000000040000000400000000000000040000000000000000000000000000000000000000000000040000000200000000000000000000000000030003000300030000000000000000000000000000000000000000000000000000000000000007000A0010000100000000000000000000000000000003000700010007000B000000020D000000000000D0C9801537064400998D00043203C0037D0902010200000028025B00FF7F000000D08022998D0004000000000000000068010100000100B5AEFBBF7EF8FFC31FFCFDFF0F4F5244455220454E5452590031373537323433004f52444552204f52444552204f524445522000003139383330393230300000003000000032363332333839303000000034343031323400004f52444552204f52444552204f524400C21516004C494E454f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f00000045555200C303083329000000C20B0A00C3024A02C3105B3EC3093545C3105B3EC30E1746C3105B3E55736572C1020000C2145100C2145100C10B3100C10B3100787D0C100B2803005348495020504F494E540000435553544F4D4552205049434B205550300000003E626600313735373234330031000000787D0C08010101004F5244455220454E54525900");
		OraCdcRedoRecord rrInsert2 = new OraCdcRedoRecord(orl, 0x0000058df34a2fadl, "0x00434e.00f8af9f.0148", baInsert2);
		assertTrue(rrInsert2.has5_1());
		assertTrue(rrInsert2.change5_1().supplementalLogData());
		assertTrue(rrInsert2.change5_1().supplementalFb() != 0);
		assertTrue(rrInsert2.change5_1().fb() == 0);
		assertFalse(rrInsert2.has10_x());
		assertTrue(rrInsert2.has11_x());
		assertTrue(rrInsert2.change11_x().fb() != 0);
		assertEquals(rrInsert2.change11_x().operation, _11_2_IRP);

		OraCdcTransaction transaction = new OraCdcTransactionArrayList("0x0077.020.001b996c", 0x0000058df34a2fadl, 0x10, orl.cdb());
		OraCdcRedoMinerStatement stmt = new OraCdcRedoMinerStatement();
		try {
			transaction.processRowChange(rrInsert1, false, System.currentTimeMillis());
			transaction.processRowChange(rrInsert2, false, System.currentTimeMillis());
			transaction.setCommitScn(0x0000058df34a31eel);

			assertTrue(transaction.completed());

			assertTrue(transaction.getStatement(stmt));
			assertEquals(stmt.getOperation(), INSERT);
			assertEquals(stmt.getRba(), rrInsert1.rba());
			assertEquals(stmt.getRowId().toString(), "AAApsfAAQAAAI2ZAAB");
			System.out.println(stmt);

		} catch(IOException ioe) {}

	}

}
