/**
 * Copyright (c) 2018-present, A2 Re≈°itve d.o.o.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is
 * distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See
 * the License for the specific language governing permissions and limitations under the License.
 */

package solutions.a2.cdc.oracle.internals;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static solutions.a2.cdc.oracle.OraCdcTransaction.LobProcessingStatus.REDOMINER;
import static solutions.a2.cdc.oracle.OraCdcV$LogmnrContents.DELETE;
import static solutions.a2.cdc.oracle.internals.OraCdcChange._11_2_IRP;
import static solutions.a2.cdc.oracle.internals.OraCdcChange._11_3_DRP;
import static solutions.a2.oracle.utils.BinaryUtils.hexToRaw;

import java.io.IOException;
import java.nio.file.Path;
import java.sql.SQLException;
import java.time.ZoneId;

import org.junit.jupiter.api.Test;

import solutions.a2.cdc.oracle.OraCdcLobExtras;
import solutions.a2.cdc.oracle.OraCdcRawTransaction;
import solutions.a2.cdc.oracle.OraCdcRedoMinerStatement;
import solutions.a2.cdc.oracle.OraCdcTransactionArrayList;
import solutions.a2.oracle.internals.Xid;

/**
 *  
 * @author <a href="mailto:averemee@a2.solutions">Aleksei Veremeev</a>
 * 
 */
public class Op11_3_Test extends TestWithOutput {

	@Test
	public void singleRedoRecord() {

		var orl = OraCdcRedoLog.getLinux19c();

		var baDelete1 = hexToRaw("B0020000050000008925DA03010000003A00ADD1000000000000010003000000030000000A0000008825DA03000000008725DA03000000008C25DA0300000000369B9A4805021B000B00FFFFD0004002AC22DA03000000000100FFFF030000000000000006002000040000001B00000043100000E30B4002B6041A005200F8000000000000000000000000003A00ADD105011C000B00FFFFE30B4002A822DA03000000000300FFFF03000000000000001C0014004C0020003100030004000800030007000300020002001400F800B00F1200000006001B0043100000B6041A6D412701004127010005000000000000000B011B00080C010000000000E30B4002B6041700C794D80300000000D594D80300000000FFFF0000FFFFFFFFFFFFFFFFE10B40020000000000000000040D00000000000002001A00C20E0000540B40029B05180000800080AC19C403DF000003DA000003FA122201020000002C000800000000001800000000000000E0FC5B46010000002B0002000000000000000000C24C16005741524453414C45534D414EC24D630077B5021601010100C20D3300C2060000C11F0000041C0000010001000000000000000000000200000B0301000C000100DF000003281DC403000000000102412703000000000000000600180014000000010D00000000000006001B0043100000E30B4002B6041A00DF000003DA000003FA120301020000000200000005130000000000000000000000000000000000000006000003000000000000002000080003000300000006000C000500030020000000060004000400000000000000A699E900000053595300535953006F7261636C6500003932326264343936653439317074732F300000003633380073716C706C7573403932326264343936653439312028544E532056312D563329000001000000000000000013FFFFFFFF");
		var rrDelete1 = new OraCdcRedoRecord(orl, 0x0000000003da2589l, "0x000362.000011e8.0010", baDelete1);
		assertTrue(rrDelete1.has5_1());
		assertTrue(rrDelete1.change5_1().supplementalLogData());
		assertTrue(rrDelete1.change5_1().supplementalFb() != 0);
		assertTrue(rrDelete1.change5_1().fb() != 0);
		assertFalse(rrDelete1.has10_x());
		assertTrue(rrDelete1.has11_x());
		assertTrue(rrDelete1.change11_x().fb() == 0);
		assertEquals(rrDelete1.change11_x().operation, _11_3_DRP);

		var raw = new OraCdcRawTransaction(new Xid((short)6, (short)0x1b, 0x1043), ZoneId.systemDefault(), 0x10, new OraCdcLobExtras());
		try {
			raw.add(rrDelete1, (int)(System.currentTimeMillis() / 1000));
			raw.commitScn(0x0000000003da258al);
			var transaction = new OraCdcTransactionArrayList(raw, orl.cdb(), REDOMINER, Path.of(System.getProperty("java.io.tmpdir")));
			var stmt = new OraCdcRedoMinerStatement();

			assertTrue(transaction.completed());

			assertTrue(transaction.getStatement(stmt));
			assertEquals(stmt.getOperation(), DELETE);
			assertEquals(stmt.getRba(), rrDelete1.rba());
			assertEquals(stmt.getRowId().toString(), "AAASdBAAMAAAADfAAC");
			System.out.println(stmt);

		} catch(IOException | SQLException e) {}
	}

	@Test
	public void testRaInterfaceLinesAll() {
		var orl = OraCdcRedoLog.getLinux19c();

		var baDelete1 = hexToRaw("8003000001508D05707463F2EE02000007D7CD51000000000502CF001500FFFFD0094203707463F28D0500003B00FFFF030000000000000004002000170000000000000065E54E15C1D501000A00A002FF7F000000000000000000000501D0005500FFFF65E54E15707463F28D0500000101FFFF0300000000000000C2001400180010003C0005000B00070012000800060001000800010006000F0003000400400003000400000003000000030000000000040000000300000000000000040000000400000000000000040000000000000000000000000000000000000000000000040000000200050007000700000000000200020002000300030000000100060000000000000000000000000000000000000000000000000007000D0006000600000000000000000000000000000003000700010007000B0000001C000000A0022A010A0000006000170034202C00C1D501001F9B02001F9B02000700000064E54E150B01170000003420020D8115E071040064E54E15C1D50A00BF8D00043203C0037D0922010900000028005B68FF7F000002EFC012BF8D00040C000000000000008A010D00000000B5AEFBBF30C8FFC31FFCFDFF0FC40E08010DF769164F5244455220454E5452590031373537333135004f52444552204f52444552204f52444552200100313938333439333732323735383200003000E59B32363333343939363001100034343030323004004f52444552204f52444552204f524400C21516004C494E454f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444545555200C2074A15C20B0A00C20B3E00C307295DC23E4500C307295DC30A4944C307295D55736572C1020000C40C2A3C36000300787D0C0F01010100787D0C0F01010100C1020000C1100000C1100000C12D5900C12D590050000000C5022E3832560000787D0C0F01010100435553544F4D45522053495445000000434852434F4E000032323735383200003E626600313735373331350031000000787D0C09010101004F5244455220454E545259000408000009000100000000000000000000000000BF8D00040D0000000B0301001A000200BF8D0004707463F28D0500000C001F9B03000000000000000600100014000100020D0000E843506865E54E15C1D50100BF8D00043203C0037D090301090000000D000068");
		var rrDelete1 = new OraCdcRedoRecord(orl, 0x0000058df2637470l, "0x00434a.0082abde.0040", baDelete1);
		assertTrue(rrDelete1.has5_1());
		assertTrue(rrDelete1.change5_1().supplementalLogData());
		assertTrue(rrDelete1.change5_1().supplementalFb() != 0);
		assertTrue(rrDelete1.change5_1().fb() != 0);
		assertFalse(rrDelete1.has10_x());
		assertTrue(rrDelete1.has11_x());
		assertTrue(rrDelete1.change11_x().fb() == 0);
		assertEquals(rrDelete1.change11_x().operation, _11_3_DRP);

		var baDelete2 = hexToRaw("1004000001028D05707463F2EF02000007D7CD510000304C0501D0005500FFFF65E54E15707463F28D0500000200FFFF03000000000000000A02140018001000500007000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000030001001E001E001E00000006000000000000000300030001000000000000000000010007000400070006000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200070005001C0000007403341D220000006000170034202C00C1D502001F9B02001F9B020007000000000000000B01170100003420020D8115E071040065E54E15C1D50100BF8D00043203C0037D092201090000000400FF68FF7F000002EFC012BF8D00040C00000000000000AD010C00007EFFFFFFFFFFFFFFFFEFFFFFFDFF0F3A1EECFFFFFFFFFFFFBBFFFFFFFFFFFF8F7F00003035353230383703C408223D03050000313331313400000043410000323632003000100020202020202020202020202020202020202020202020202020202020203103002020202020202020202020202020202020202020202020202020202020302E00202020202020202020202020202020202020202020202020202020202030F71F3839303831390100C20C0800C20B640C536E63F280050000787D0C0F12113C00C3023750787D0C0F182E1E00C502304C4A210000C154400359713E00C2033F00C1020000787D0C090A1A1106C41B2232610400000404000009005C00000000000000000000000000BF8D00040D0000000B0301001A000200BF8D0004707463F28D0500000D001F9B03000000000000000600100014000100020D0000E843506865E54E15C1D50200BF8D00043203C0037D090301090000000C000068");
		var rrDelete2 = new OraCdcRedoRecord(orl, 0x0000058df2637470l, "0x00434a.0082abde.0040", baDelete2);
		assertTrue(rrDelete2.has5_1());
		assertTrue(rrDelete2.change5_1().supplementalLogData());
		assertTrue(rrDelete2.change5_1().supplementalFb() != 0);
		assertTrue(rrDelete2.change5_1().fb() != 0);
		assertFalse(rrDelete2.has10_x());
		assertTrue(rrDelete2.has11_x());
		assertTrue(rrDelete2.change11_x().fb() == 0);
		assertEquals(rrDelete2.change11_x().operation, _11_3_DRP);

		var raw = new OraCdcRawTransaction(new Xid((short)0x60, (short)0x17, 0x2c2034), ZoneId.systemDefault(), 0x10, new OraCdcLobExtras());
		try {
			raw.add(rrDelete1, (int)(System.currentTimeMillis() / 1000));
			raw.add(rrDelete2, (int)(System.currentTimeMillis() / 1000));
			raw.commitScn(0x0000058df2637471l);
			var transaction = new OraCdcTransactionArrayList(raw, orl.cdb(), REDOMINER, Path.of(System.getProperty("java.io.tmpdir")));
			var stmt = new OraCdcRedoMinerStatement();

			assertTrue(transaction.completed());

			assertTrue(transaction.getStatement(stmt));
			assertEquals(stmt.getOperation(), DELETE);
			assertEquals(stmt.getRba(), rrDelete1.rba());
			assertEquals(stmt.getRowId().toString(), "AAApsfAAQAAAI2/AAN");
			System.out.println(stmt);

		} catch(IOException | SQLException e) {}
	}

	@Test
	public void partialRollbackScottDept() {

		var orl = OraCdcRedoLog.getLinux19c();


		/*
		 * SCN:65561545, RBA:0x000369.0000108c.0010,
		 */
		var baDelete1 = hexToRaw("9802000005000000C963E803010000003A00ADD1000000000000010003000000030000000A000000C963E80300000000B663E80300000000CD63E80300000000367CF848050221000B00FFFF000140021663E803000000000100FFFF0300000000000000060020000400000007000000660F00009009400283030F005200DC000000000000000000000000003A00ADD1050122000B00FFFF900940021563E803000000000600FFFF0300000000000000120014004C002000310002000A0008001400EAB4DC00A6171200000009000700660F000083030F00042201000422010005000000000000000B010700080C010000000000900940028303090057D4E6030000000069D4E60300000000FFFF0000FFFFFFFFFFFFFFFF8D0940020000000000000000040D00000000000006001D002110000064084002B504200000800080C0A3CB038400000382000003FA122201010000002C000300000000001800000000000000C0225846010000001A0000000000000000000000C10B00004143434F554E54494E4700004E455720594F524B041C0000010001000000000000000000000200000B0301000C000100840000038BA5CB03000000000102042203000000000000000600180014000000010D00000000000009000700660F00009009400283030F008400000382000003FA120301010000000000000005130000000000000000000000000000000000000006000003000000000000002000080003000300000006000C00050003002000000006000400040000000000000041E0CC00000053595300535953006F7261636C6500003932326264343936653439317074732F300000003136370073716C706C7573403932326264343936653439312028544E532056312D563329000001000000000000000013FFFFFFFF");
		var rrDelete1 = new OraCdcRedoRecord(orl, 0x0000000003e863c9l, "0x000369.0000108c.0010", baDelete1);

		assertTrue(rrDelete1.has5_1());
		assertTrue(rrDelete1.change5_1().supplementalLogData());
		assertTrue(rrDelete1.change5_1().supplementalFb() != 0);
		assertTrue(rrDelete1.change5_1().fb() != 0);
		assertFalse(rrDelete1.has10_x());
		assertTrue(rrDelete1.has11_x());
		assertTrue(rrDelete1.change11_x().fb() == 0);
		assertFalse(rrDelete1.change11_x().compressed());
		assertEquals(rrDelete1.change11_x().operation, _11_3_DRP);

		/*
		 * SCN:65561549, RBA:0x000369.0000108f.0010,
		 */
		var baInsert1 = hexToRaw("4001000005000000CD63E803010000003A00ADD1000000000000010001000000010000000A000000CD63E80300000000CC63E80300000000D063E80300000000367CF8480B0201000C00010084000003C963E803000000000100042203000000000000000E002000310002000A00080014000000040D00000000000006001D002110000064084002B504200000800080C0A3CB038400000382000003FA122202010000002C000300000000001800000000000000C0225846010000001A0000000000000000000000C10B00004143434F554E54494E4700004E455720594F524B041C000001000100000000000000000000020000050B21000B00FFFF00014002C963E803000000000100FFFF030000000000000006001C0008000000042201000422010005000000000000000B010700180C010000000000F816433302000000");
		var rrInsert1 = new OraCdcRedoRecord(orl, 0x0000000003e863cdl, "0x000369.0000108f.0010", baInsert1);
		assertTrue(rrInsert1.hasPrb());
		assertFalse(rrInsert1.has5_1());
		assertFalse(rrInsert1.has10_x());
		assertTrue(rrInsert1.has11_x());
		assertEquals(rrInsert1.change11_x().operation, _11_2_IRP);
		assertTrue(rrInsert1.change11_x().fb() != 0);

		var raw = new OraCdcRawTransaction(new Xid((short)6, (short)0x1d, 0x1021), ZoneId.systemDefault(), 0x10, new OraCdcLobExtras());
		try {
			raw.add(rrDelete1, (int)(System.currentTimeMillis() / 1000));
			raw.add(rrInsert1, (int)(System.currentTimeMillis() / 1000));
			raw.commitScn(0x0000000003e863cel);
			var transaction = new OraCdcTransactionArrayList(raw, orl.cdb(), REDOMINER, Path.of(System.getProperty("java.io.tmpdir")));
			var stmt = new OraCdcRedoMinerStatement();

			assertTrue(transaction.completed());

			assertFalse(transaction.getStatement(stmt));

		} catch(IOException | SQLException e) {}
	}

}
