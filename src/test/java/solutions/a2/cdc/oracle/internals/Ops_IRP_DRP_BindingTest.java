/**
 * Copyright (c) 2018-present, A2 Re≈°itve d.o.o.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is
 * distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See
 * the License for the specific language governing permissions and limitations under the License.
 */

package solutions.a2.cdc.oracle.internals;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static solutions.a2.cdc.oracle.OraCdcV$LogmnrContents.UPDATE;
import static solutions.a2.cdc.oracle.internals.OraCdcChange._11_2_IRP;
import static solutions.a2.cdc.oracle.internals.OraCdcChange._11_3_DRP;
import static solutions.a2.cdc.oracle.internals.OraCdcChange._11_5_URP;
import static solutions.a2.cdc.oracle.internals.OraCdcChange._11_8_CFA;
import static solutions.a2.oracle.utils.BinaryUtils.hexToRaw;

import java.io.IOException;

import org.apache.log4j.BasicConfigurator;
import org.junit.jupiter.api.Test;

import solutions.a2.cdc.oracle.OraCdcRedoMinerStatement;
import solutions.a2.cdc.oracle.OraCdcTransaction;
import solutions.a2.cdc.oracle.OraCdcTransactionArrayList;

/**
 *  
 * @author <a href="mailto:averemee@a2.solutions">Aleksei Veremeev</a>
 * 
 */
public class Ops_IRP_DRP_BindingTest {

	@Test
	public void test_IRP_DRP_CFA_Binding() {

		BasicConfigurator.configure();

		OraCdcRedoLog orl = OraCdcRedoLog.getLinux19c();
		
		byte[] baUpdate1 = hexToRaw("3804000001008D055D79A4D50F00000007D7CD51000006000501BC005D00FFFF681840175D79A4D58D0500000200FFFF0300000000000000CE001400180010001D000C000100070005000800030007001400B000B000040003000700040007000300060000000000000002000000000007000700020007000300070000000000000000000300030001000000000000000000000000000000000000000000000000000000000000000000000001000100000000000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000010001000100010001000000020002000200000000005003F20922000000560007001E6D3300CD612700D8A40200D8A402000B000000000000000B01072600001E6D020D00000000000068184017CD612600F3DA4106F21EC0057D092501070000002C0700001A005D060000000000947A0B4D004E004F0050005100520080028D00C60A646464646400C3030D1455001100C60A646462585011C2572908C60A6464640E3C05015C580017004E004E00000000100000000000000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F0020002100220023002400250026002700280029002A002B002C002D002E002F0030003100320033003400350036003700380039003A003B003C003D003E003F0040004100420043004400450046004700480049004A004B004C004D005400550056005700580059005A005B005C005D005E000400030007000400070003000600FFFFFFFFFFFF0200FFFFFFFF070007000200070003000700FFFFFFFFFFFFFFFF030003000100FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF01000100FFFFFFFFFFFF0500FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0200FFFF01000100010001000100FFFF020002000200FFFFC3155E5AC2033E00787D0B19162A3B00C3033854787C06060D1C3A00C2151200C5021C42153F4795C1041600C60A64646464640052445A2D415652464C426A8EC60A64646464640046543315C60A64646464640B3837300752445A01310000004E028D0059001202464C4F4F52050000C11511008000000080022D59802F14004E1C000059000C00C1020000C1020000C10200000B05010026000200F3DA41065D79A4D58D0500000100D8A40300000000000000140010001D000C00010007000500080003000700020D84050000000068184017CD612700F3DA4106F21EC0057D090501070000002C0700001A005D0600000000000004004D004E004F0050005100520080058D05C60A646464646408C3025F3435000000C60A646463063031C2501503C60A646464155000");
		OraCdcRedoRecord rrUpdate1 = new OraCdcRedoRecord(orl, 0x0000058dd5a4795dl, "0x0042b3.001edd23.011c", baUpdate1);
		assertTrue(rrUpdate1.has5_1());
		assertTrue(rrUpdate1.change5_1().supplementalLogData());
		assertTrue(rrUpdate1.change5_1().supplementalFb() != 0);
		assertTrue(rrUpdate1.change5_1().fb() != 0);
		assertFalse(rrUpdate1.has10_x());
		assertTrue(rrUpdate1.has11_x());
		assertEquals(rrUpdate1.change11_x().operation, _11_5_URP);
		assertTrue(rrUpdate1.change11_x().fb() != 0);

		byte[] baInsert1 = hexToRaw("9C02000001058D055D79A4D52900000007D7CD51000014000501BC005D00FFFF681840175D79A4D58D0500000500FFFF03000000000000000C0014001800080014001C005C00BC0522000000560007001E6D3300CD612A00D8A40200D8A402000B000000000000000B01072900001E6D030DA0460E000000228A0106F21EC0057D09230101000000000000520108000017000000010000000010000000000000CB860106040000000B02010025000200228A01060E8762AC8D0500000200D8A40300000000000000C00018003C00040003000700030007000300000000000000000002000400000007000300020005000200050000000000000000000300030001000000000000000000000000000000000000000000000000000000000000000000000001000100000000000000090000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000100050004000600030007000000010001000100010001000400020002000200010D840500000000560007001E6D330068184017CD612A00228A0106F21EC0057D090201010000000C015D00CB86010604000000000000000000000000000000E200000000C01378FCFFE7FAFFFF0F0800000000C3160C61C2033ED5787D0B19161F0900C21056FF787C06060F3134153E646600C1040000C358011EC664646464646400414647004C424003C40A6464648500804541A4D5C40A646464939E073837300130323900330000004E1C0000590000004156522D505A2031330000003230393336331600C115FD0A804CA4D5C40A646464029691C2124521C40A64531F451800C2081500C6646464645D5000800000008000030080000200590D00004E000000C358011EC1022D00C1028015C1020200"); 
		OraCdcRedoRecord rrInsert1 = new OraCdcRedoRecord(orl, 0x0000058dd5a4795dl, "0x0042b3.001edd2b.0190", baInsert1);
		assertTrue(rrInsert1.has5_1());
		assertTrue(rrInsert1.change5_1().supplementalLogData());
		assertTrue(rrInsert1.change5_1().supplementalFb() != 0);
		assertTrue(rrInsert1.change5_1().fb() == 0);
		assertFalse(rrInsert1.has10_x());
		assertTrue(rrInsert1.has11_x());
		assertTrue(rrInsert1.change11_x().fb() != 0);
		assertEquals(rrInsert1.change11_x().operation, _11_2_IRP);

		byte[] baDelete1 = hexToRaw("B802000001938D055D79A4D52A00000007D7CD5100000B090501BC005D00FFFF681840175D79A4D58D0500000600FFFF0300000000000000C6001400180020003C000400030007000300070003000000000000000000020004000000070003000200050002000500000000000000000003000300010000000000000000000000000000000000000000000000000000000000000000000000010001000000000000000900000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020001000500010005000100070000000100010001000100010004000200020002001C00000014025E0522000000560007001E6D3300CD612B00D8A40200D8A402000B000000000000000B01072A00001E6D040D000000000000070020008C6E2F00256B8315E04303008D850080F47051D5710FC305F21EC0057D092201060000000C005D6DCB86010604004152FD7F0000C0E97F730D7F0000DC00000000C01378FCFFE7FAFFFF0F080010256EC3160C61C2033E00787D0B19161F0900C21056D5787C06060F3134003E646600C1040000C358011EC664646464646400414647054C42A4D5C40A646464D7CD514541C408C40A6464640000003837300030323900334CA4D54E050000594CA4D54156522D505A203133050000323039333633CF00C115FFFF80094203C40A6464640500008000FFFFC40A64646400000080002000C66464646464640080F02B0080FD411780D320005900A0004E000000C358011EC1020000C102CD51C102D0000100000017000100000000000010000000000000CB860106040000000B03010024000200710FC3055D79A4D58D0500000100D8A403000000000000000600180014000000010DB76D0D7F0000560007001E6D330068184017CD612B00710FC305F21EC0057D0903010600000000000000");
		OraCdcRedoRecord rrDelete1 = new OraCdcRedoRecord(orl, 0x0000058dd5a4795dl, "0x0042b3.001edd2d.004c", baDelete1);
		assertTrue(rrDelete1.has5_1());
		assertTrue(rrDelete1.change5_1().supplementalLogData());
		assertTrue(rrDelete1.change5_1().supplementalFb() == 0);
		assertTrue(rrDelete1.change5_1().fb() != 0);
		assertFalse(rrDelete1.has10_x());
		assertTrue(rrDelete1.has11_x());
		assertTrue(rrDelete1.change11_x().fb() == 0);
		assertEquals(rrDelete1.change11_x().operation, _11_3_DRP);

		assertEquals(rrInsert1.halfDoneKey(), rrDelete1.halfDoneKey());

		byte[] baCfa1 = hexToRaw("2401000001FF8D055D79A4D52B00001707D7CD51000000000501BC005D00FFFF681840175D79A4D58D0500000700FFFF0300000000000000120014001800100020001C00020002000000B76D7C00480322000000560007001E6D3300CD612C00D8A40200D8A402000B000000000000000B01072B00001E6D020DB76D0D7F000068184017CD612500CB860106F21EC0057D09280105000000710FC30500007F7304000000057F00000144010017000000000000000010000000000000CB860106040000005E000000FFFF0D000B08010025000200CB8601065D79A4D58D0500000200D8A403000000000000000600100020000000020D07001E6D330068184017CD612C00CB860106F21EC0057D09080105000000228A01060000000004000000057F0000");
		OraCdcRedoRecord rrCfa1 = new OraCdcRedoRecord(orl, 0x0000058dd5a4795dl, "0x0042b3.001edd2e.0114", baCfa1);
		assertTrue(rrCfa1.has5_1());
		assertTrue(rrCfa1.change5_1().supplementalLogData());
		assertFalse(rrCfa1.has10_x());
		assertTrue(rrCfa1.has11_x());
		assertEquals(rrCfa1.change11_x().operation, _11_8_CFA);

		assertEquals(rrInsert1.halfDoneKey(), rrCfa1.halfDoneKey());

		OraCdcTransaction transaction = new OraCdcTransactionArrayList("0x0056.007.00336d1e", 0x0000058dd5a4795dl, 0x10, orl.cdb());
		OraCdcRedoMinerStatement stmt = new OraCdcRedoMinerStatement();
		try {
			transaction.processRowChange(rrUpdate1, false, System.currentTimeMillis());
			transaction.processRowChange(rrInsert1, false, System.currentTimeMillis());
			transaction.processRowChange(rrDelete1, false, System.currentTimeMillis());
			transaction.processRowChangeLmn(rrCfa1, System.currentTimeMillis());
			transaction.setCommitScn(0x0000058dd5a4795el);

			assertTrue(transaction.completed());

			assertTrue(transaction.getStatement(stmt));
			assertEquals(stmt.getOperation(), UPDATE);
			assertEquals(stmt.getRba(), rrUpdate1.rba());
			assertEquals(stmt.getRowId().toString(), "AAAqTYAAZAAAdrzAAa");
			System.out.println(stmt);

			assertTrue(transaction.getStatement(stmt));
			assertEquals(stmt.getOperation(), UPDATE);
			assertEquals(stmt.getRba(), rrInsert1.rba());
			assertEquals(stmt.getRowId().toString(), "AAAqTYAAYAAAYbLAAE");
			System.out.println(stmt);

		} catch(IOException ioe) {}

	}


}
