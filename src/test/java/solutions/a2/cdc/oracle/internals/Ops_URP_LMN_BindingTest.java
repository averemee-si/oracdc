/**
 * Copyright (c) 2018-present, A2 Re≈°itve d.o.o.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is
 * distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See
 * the License for the specific language governing permissions and limitations under the License.
 */

package solutions.a2.cdc.oracle.internals;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static solutions.a2.cdc.oracle.OraCdcV$LogmnrContents.UPDATE;
import static solutions.a2.cdc.oracle.internals.OraCdcChange._11_5_URP;
import static solutions.a2.cdc.oracle.internals.OraCdcChange._11_16_LMN;
import static solutions.a2.oracle.utils.BinaryUtils.hexToRaw;

import java.io.IOException;

import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.Strings;
import org.apache.log4j.BasicConfigurator;
import org.junit.jupiter.api.Test;

import solutions.a2.cdc.oracle.OraCdcRedoMinerStatement;
import solutions.a2.cdc.oracle.OraCdcTransaction;
import solutions.a2.cdc.oracle.OraCdcTransactionArrayList;

/**
 *  
 * @author <a href="mailto:averemee@a2.solutions">Aleksei Veremeev</a>
 * 
 */
public class Ops_URP_LMN_BindingTest {

	@Test
	public void test() {

		BasicConfigurator.configure();

		OraCdcRedoLog orl = OraCdcRedoLog.getLinux19c();
		
		byte[] baUpdate1 = hexToRaw("B40400000100060D26CD389602000096000000000000FFFF050172000500FFFF296F420126CD3896060D00000100FFFF0000000000000000CC001400180010001D00020001001400B800B80004000200020003000200040001000700070003000000000003000300040004000000050005000500020002000200020001000300030000000600040003000400020002000200020002000200020000000100010002000300030002000300070003000100020002000200020002000100000002000400020002000200020002000100020002000100020002000000000001000000000000000000010002000000030001000100000000000200020002000200020006000000F003FA1922000000310014001CF0E100024807005B6143045B61430406000000000000000B01140600001CF0020D000000000000296F420102480600EB03EC03EA03EC03FA122501020000002C02000000005C01F4FF00000000A0002D0004015800000001585C0010002E002E00000000100000000200000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F0020002100220023002400250026002700280029002A002B002C002D002F0030003100320033003400350036003700380039003A003B003C003D003E003F0040004100420043004400450046004700480049004A004B004C004D004E004F0050005100520053005400550056005700580059005A005B005C005D000400020002000300020004000100070007000300FFFFFFFF0300030004000400FFFF0500050005000200020002000200010003000300FFFF06000400030004000200020002000200020002000200FFFF0100010002000300030002000300070003000100020002000200020002000100FFFF0200040002000200020002000200010002000200010002000200FFFFFFFF0100FFFFFFFFFFFFFFFF01000200FFFF030001000100FFFFFFFF020002000200020002000600FFFFC30B0108C1110000C10200003E596600C10500003733303380000000787B04140F3433007872011501010100C2224C00C2081B00C2075000C30D245B37333033554E444546000000554E444546000000554E444546000000C1020000C1150000C3150000C102000080000000C15C2B00C1613F0030303033334601004E4F4E45414654004E4F434CC1020000C1020000C1070100C1020000C1020100C1020000C1100100800014008004341FC107F357C24A04003E646600C1050200C2050404787B04140F3433003E64660080011801C102D44EC10201E9C102001EC1024101C10201008016B200C102A000C3411807C1090000C10B7900C102C7C7C1020034C102F2FF80070000C1031FFFC102E7FF80FFFFFFC1021800C1027F808000010080000300C1020500535444008000090080000B00C1020D00C1020F00C1021100C1021300C1021500C505010B010819000B05010006004304EB03EC0326CD3896060D000001005B610000000000000000100010001D0008000100010001000300020D38960080060D296F420102480700EB03EC03EA03EC03FA120501020000002C020000000063040C000000000049002D005C006100620059004F0080005100010053003E646600");
		OraCdcRedoRecord rrUpdate1 = new OraCdcRedoRecord(orl, 0x00000d069638cd26l, "0x026f56.0045d463.0054", baUpdate1);
		assertTrue(rrUpdate1.has5_1());
		assertFalse(rrUpdate1.has10_x());
		assertTrue(rrUpdate1.has11_x());
		assertEquals(rrUpdate1.change11_x().operation, _11_5_URP);

		byte[] ba_11_16Lmn1 = hexToRaw("280100000100060D26CD3896030000000000000000006100050172000500FFFF296F420126CD3896060D00000200FFFF0000000000000000140014001800100010001C0004000400010003007800081622000000310014001CF0E100024808BC5B6143045B61430406000000000000000B01140700001CF0020D8E9009000000296F420102480700EB03EC03EA03EC03FA123001020000000144020010000000000000000014000000020000EB03EC03000000005D006300010003008000B5003E6466000B10010006004304EB03EC0326CD3896060D000002005B6100000000000000000800100010001C00020D010001000300296F420102480800EB03EC03EA03EC03FA12100102000000015C000010000000000000000014000000020000EB03EC0300000000"); 
		OraCdcRedoRecord rr_11_16Lmn1 = new OraCdcRedoRecord(orl, 0x00000d069638cd26l, "0x026f56.0045d465.0128", ba_11_16Lmn1);
		assertTrue(rr_11_16Lmn1.has5_1());
		assertFalse(rr_11_16Lmn1.has10_x());
		assertTrue(rr_11_16Lmn1.has11_x());
		assertEquals(rr_11_16Lmn1.change11_x().operation, _11_16_LMN);

		byte[] baUpdate2 = hexToRaw("B8040000017D060D8CCE3896020000000000000000000100050172000500FFFF296F42018CCE3896060D00000100FFFF0000000000000000CC001400180010001D00020001001400B800B8000400020002000300020004000100070007000300000000000300030003000A000000050005000500020002000200020001000200030000000100040003000400020002000200020002000200020000000100010002000300030002000300070003000200010002000200020002000100000002000400020002000200020002000100020002000100020002000000000001000000000000000000020002000000030001000100000000000200020002000200020006000000F403301522000000310014001CF0E10002480ABD5B6143045B61430406000000000000000B01140900001CF0020D000000000000296F420102480900EB03EC03EA03EC03FA122501020000002C028B0001005C01F4FF0000000000002D0000005800000001585C0010002E002E00000000100000000200000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F0020002100220023002400250026002700280029002A002B002C002D002F0030003100320033003400350036003700380039003A003B003C003D003E003F0040004100420043004400450046004700480049004A004B004C004D004E004F0050005100520053005400550056005700580059005A005B005C005D000400020002000300020004000100070007000300FFFFFFFF0300030003000A00FFFF0500050005000200020002000200010002000300FFFF01000400030004000200020002000200020002000200FFFF0100010002000300030002000300070003000200010002000200020002000100FFFF0200040002000200020002000200010002000200010002000200FFFFFFFF0100FFFFFFFFFFFFFFFF02000200FFFF030001000100FFFFFFFF020002000200020002000600FFFFC315010CC1380300C10205003E596600C10509003735303780000D0078730601072505007872011501010100C2056000C20F1300C2054500C2086100333030303030383638392300554E444546002700554E444546002B00554E444546002F00C1023100C1033300C2333500C202370080003900C1523B00C157160030003F0041545356414654004E4F434CC1024700C1024900C1074B00C1024D00C1024F00C1025100C11053008000550080005700C1075900C24C0800C2031900C1055F00C2063B007873060107250500C2031900C102690080006B00C1026D00C1026F00C1027100C102730080007500C1027700C3195B0FC10A7B00C1067D00C1027F00C1028100C102830080008500C1038700C102890080008B00C1028D00C1028F0080009100C1029300C1029500535444008000990080009B00C1029D00C1029F00C102A100C102A300C102A500C5050115010CA9000B05010006004304EB03EC038CCE3896060D000001005B610000000000000000100010001D0008000100010001000300020D38960080060D296F420102480A00EB03EC03EA03EC03FA120501020000002C028B00010063040C000000000501002D005C00610062005900000080020400010000003E646600");
		OraCdcRedoRecord rrUpdate2 = new OraCdcRedoRecord(orl, 0x00000d069638ce8cl, "0x026f56.0045d6af.0130", baUpdate2);
		assertTrue(rrUpdate2.has5_1());
		assertFalse(rrUpdate2.has10_x());
		assertTrue(rrUpdate2.has11_x());
		assertEquals(rrUpdate2.change11_x().operation, _11_5_URP);

		byte[] ba_11_16Lmn2 = hexToRaw("280100000100060D8CCE3896030000000000000000000000050172000500FFFF296F42018CCE3896060D00000200FFFF0000000000000000140014001800100010001C00040004000100030078003A1122000000310014001CF0E10002480BC25B6143045B61430406000000000000000B01140A00001CF0020D8E9009000000296F420102480A00EB03EC03EA03EC03FA123001020000000144020010000000000000000014000000020000EB03EC03010000005D00630001000300800000003E6466000B10010006004304EB03EC038CCE3896060D000002005B6100000000000000000800100010001C00020D010001000300296F420102480B00EB03EC03EA03EC03FA12100102000000015C000010000000000000000014000000020000EB03EC0301000000"); 
		OraCdcRedoRecord rr_11_16Lmn2 = new OraCdcRedoRecord(orl, 0x00000d069638ce8cl, "0x026f56.0045d6b2.0018", ba_11_16Lmn2);
		assertTrue(rr_11_16Lmn2.has5_1());
		assertFalse(rr_11_16Lmn2.has10_x());
		assertTrue(rr_11_16Lmn2.has11_x());
		assertEquals(rr_11_16Lmn2.change11_x().operation, _11_16_LMN);

		OraCdcTransaction transaction = new OraCdcTransactionArrayList("0x0031.014.00e1f01c", 0x00000d069638cd26l, 0x10, orl.cdb());
		OraCdcRedoMinerStatement stmt = new OraCdcRedoMinerStatement();
		try {
			transaction.processRowChange(rrUpdate1, false, System.currentTimeMillis());
			transaction.processRowChangeLmn(rr_11_16Lmn1, System.currentTimeMillis());
			transaction.processRowChange(rrUpdate2, false, System.currentTimeMillis());
			transaction.processRowChangeLmn(rr_11_16Lmn2, System.currentTimeMillis());
			transaction.setCommitScn(0xd0696390dd8l);

			assertTrue(transaction.completed());

			assertTrue(transaction.getStatement(stmt));
			assertEquals(stmt.getOperation(), UPDATE);
			assertEquals(stmt.getRba(), rrUpdate1.rba());
			assertEquals(stmt.getRowId().toString(), "AEQ2FbAAPAALAPrAAA");
			assertTrue(Strings.CS.contains(stmt.toString(), "\"COL 46\" = '59'"));
			assertTrue(Strings.CS.contains(stmt.toString(), "\"COL 93\" = '80'"));
			assertTrue(Strings.CS.contains(stmt.toString(), "\"COL 99\" = '3e6466'"));
			assertTrue(Strings.CS.contains(
					StringUtils.substringAfter(stmt.toString(), " where "),
					"\"COL 46\" = '58'"));
			System.out.println(stmt);

			assertTrue(transaction.getStatement(stmt));
			assertEquals(stmt.getOperation(), UPDATE);
			assertEquals(stmt.getRba(), rrUpdate2.rba());
			assertEquals(stmt.getRowId().toString(), "AEQ2FbAAPAALAPrAAB");
			assertTrue(Strings.CS.contains(stmt.toString(), "\"COL 46\" = '59'"));
			assertTrue(Strings.CS.contains(stmt.toString(), "\"COL 93\" = '80'"));
			assertTrue(Strings.CS.contains(stmt.toString(), "\"COL 99\" = '3e6466'"));
			assertTrue(Strings.CS.contains(
					StringUtils.substringAfter(stmt.toString(), " where "),
					"\"COL 46\" = '58'"));
			System.out.println(stmt);

		} catch(IOException ioe) {}

	}

	@Test
	public void testRaInterfaceLinesAll() {
		BasicConfigurator.configure();

		OraCdcRedoLog orl = OraCdcRedoLog.getLinux19c();
		
		byte[] baUpdate1 = hexToRaw("9404000001138D0543B24CD21A00000007D7CD51000000000501A4001500FFFF1D47410343B24CD28D0500001500FFFF0300000000000000C8001400180010001D00020000001C00B400B40000000B000700120008000C0001000800010006000F000300040052000300030000000300000003000000000003000000030000000000000003000000030000000000000003000000000000000000000000000000000000000000000004000000020000000000000000000000000002000200040004000000000000000000000000000000000000000000000000000000000007000D0004000C00000000000000000000000000000003000700010007000B000000E003B20A220000004A000300B64E2E007B3039211F9B02001F9B020007000000000000000B0103380000B64E020D0000000000001C4741037B300900F30001043203C0037D0925010B000000280B000001005B01FAFF0100000004003D00070001085A0009003E003E0000000010000000000000F3000104010000000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F0020002100220023002400250026002700280029002A002B002C002D002E002F0030003100320033003400350036003700380039003A003B003C003D003F0040004100420043004400450046004700480049004A004B004C004D004E004F0050005100520053005400550056005700580059005A005B00FFFF0B000700120008000C0001000800010006000F0003000400520003000300FFFF0300FFFF0300FFFFFFFF0300FFFF0300FFFFFFFFFFFF0300FFFF0300FFFFFFFFFFFF0300FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0400FFFF0200FFFFFFFFFFFFFFFFFFFFFFFF0200020004000400FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF07000D0004000C00FFFFFFFFFFFFFFFFFFFFFFFFFFFF03000700010007000B00FFFF4F5244455220454E5452590031373534303137FF4f52444552204f52444552204f5244455220000031393439303930313132313132303633373530313000060032353933343938323000130034333636373007004f52444552204f52444552204f524400C21516064C494E454f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f52444552204f524445000045555200C2160200C20B0A10C20B08D2C20C1400C20F27DAC20C1400C20F1500C20C140055736572C1020700C1150000C1150000C2020606C2020606787D0B170A0F1C10435553544F4D45522053495445002C02534149413132313132303633373530313E626617313735343031370032D78D05787D0B11010101004F5244455220454E545259010B0501001A000200F30001043DB24CD28D05000009001F9B03000000000000000A0010001D00020006000000020D0700000000001D4741037B303900F30001043203C0037D0905010B000000280B000001005B0106000000000067C03D000000C5022D505F514515");
		OraCdcRedoRecord rrUpdate1 = new OraCdcRedoRecord(orl, 0x0000058dd24cb243l, "0x0042a3.007a7bc9.013c", baUpdate1);
		assertTrue(rrUpdate1.has5_1());
		assertFalse(rrUpdate1.has10_x());
		assertTrue(rrUpdate1.has11_x());
		assertEquals(rrUpdate1.change11_x().operation, _11_5_URP);

		byte[] ba_11_16Lmn1 = hexToRaw("2C08000001008D0543B24CD21B00000007D7CD51000018000502A3001500FFFF080E42033FB24CD28D0500000100FFFF03000000000000000400200003000000000000001F4741037B3001000A003807FF7F000000000000000000000501A4001500FFFF1F47410343B24CD28D0500000101FFFF0300000000000000100214001800100010001C00000200020A000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000900000004000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000030001001E001E001E000000090000000000000000000000010000000000000000000100070001000700000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000700050000003807D0060A0000004A000300B64E2E007B3001001F9B02001F9B0200070000001D4741030B0103000000B64E020D0000000000001D4741037B303900F30001043203C0037D0930010B0000000144000109000000000000000010000040000000F3000104010000005C005D005E005F0060006100620063006400650066006700680069006A006B006C006D006E006F0070007100720073007400750076007700780079007A007B007C007D007E007F0080008100820083008400850086008700880089008A008B008C008D008E008F0090009100920093009400950096009700980099009A009B009C009D009E009F00A000A100A200A300A400A500A600A700A800A900AA00AB00AC00AD00AE00AF00B000B100B200B300B400B500B600B700B800B900BA00BB00BC00BD00BE00BF00C000C100C200C300C400C500C600C700C800C900CA00CB00CC00CD00CE00CF00D000D100D200D300D400D500D600D700D800D900DA00DB00DC00DD00DE00DF00E000E100E200E300E400E500E600E700E800E900EA00EB00EC00ED00EE00EF00F000F100F200F300F400F500F600F700F800F900FA00FB00FC00FD00FE00FF0000010101020103010401050106010701080109010A010B010C010D010E010F0110011101120113011401150116011701180119011A011B011C011D011E011F0120012101220123012401250126012701280129012A012B012C012D012E012F0130013101320133013401350136013701380139013A013B013C013D013E013F0140014101420143014401450146014701480149014A014B014C014D014E014F0150015101520153015401550156015701580159015A015B010A00FFFFFFFFFFFFFFFFFFFFFFFF0500FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0900FFFF0400FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0200FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF030001001E001E001E00FFFF0900FFFFFFFFFFFFFFFFFFFF0100FFFFFFFFFFFFFFFF0100070001000700FFFFFFFFFFFF0200FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0300FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF020007000500FFFF31373334313230393637FFFFC4044C1E5700000034383335323436313300040030303230454106003236311930000000202020202020202020202020202020202020202020202020202020202031130D20202020202020202020202020202020202020202020202020202020203025012020202020202020202020202020202020202020202020202020202020300B173939303031393631380018005300000080100000787D0B170A11380080000200787D0B170A1138D2C1540000C2033EDAC1020000787D0B1106270500C41A5E32530007000B1001001A000200F300010443B24CD28D05000001001F9B03000000000000000800100010001C00020D0000040000001F4741037B300100F30001043203C0037D0910010B0000000144000009000000000000000010000040000000F300010401000000"); 
		OraCdcRedoRecord rr_11_16Lmn1 = new OraCdcRedoRecord(orl, 0x0000058dd24cb243l, "0x0042a3.007a7bcc.0010", ba_11_16Lmn1);
		assertTrue(rr_11_16Lmn1.has5_1());
		assertFalse(rr_11_16Lmn1.has10_x());
		assertTrue(rr_11_16Lmn1.has11_x());
		assertEquals(rr_11_16Lmn1.change11_x().operation, _11_16_LMN);

		OraCdcTransaction transaction = new OraCdcTransactionArrayList("0x004a.003.002e4eb6", 0x0000058dd24cb243l, 0x10, orl.cdb());
		OraCdcRedoMinerStatement stmt = new OraCdcRedoMinerStatement();

		try {
			transaction.processRowChange(rrUpdate1, false, System.currentTimeMillis());
			transaction.processRowChangeLmn(rr_11_16Lmn1, System.currentTimeMillis());
			transaction.setCommitScn(0x0000058dd24cb255l);

			assertTrue(transaction.completed());

			assertTrue(transaction.getStatement(stmt));
			assertEquals(stmt.getOperation(), UPDATE);
			assertEquals(stmt.getRba(), rrUpdate1.rba());
			assertEquals(stmt.getRowId().toString(), "AAApsfAAQAAAQDzAAB");

			System.out.println(stmt);

		} catch(IOException ioe) {}
			
	}

}
